---
title: "Analisis Ejemplo"
author: "Alicia Perdices Guerra"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    number_sections: no
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### **1.GASTO SANITARIO POR FUNCIÓN.**

* En primer lugar leemos el fichero:

```{r}
library(scales)
gasto_fun<-read.csv("C:/temp/GastoSanitario_Funcion_clean.csv",sep= ",")
```

* Realicemos una breve inspección de los datos:

```{r}
str(gasto_fun)

```


```{r}
colnames(gasto_fun) #Nombre de las variables
nrow(gasto_fun) #Número de registros
ncol(gasto_fun) #Número de variables
```

* Filtramos el dataframe para que la variable GEO aparezcan solo los paises objeto de estudio

```{r}
gasto_fun_paises<-gasto_fun[(gasto_fun$GEO!="European Union - 27 countries (from 2020)")&
                              +(gasto_fun$GEO!="European Union - 27 countries (2007-2013)")&
                              +(gasto_fun$GEO!="Euro area - 19 countries  (from 2015)")&
                              +(gasto_fun$GEO!="Euro area - 12 countries (2001-2006)")&
                              +(gasto_fun$GEO!="European Union - 28 countries +(2013-2020)")&
                              +(gasto_fun$GEO!="European Union - 15 countries (1995-2004)")&
                              +(gasto_fun$GEO!="Euro area - 18 countries (2014)"),]
gasto_fun_paises<-gasto_fun_paises[(gasto_fun_paises$ICHA11_HC=="Current health care expenditure (CHE)"),]


```

* Transformamos el valor de la variable "Value" a unidades.

```{r}
#Ahora reescalamos un variable "Value" del Dataframe
gasto_fun_paises$Value<-gasto_fun_paises$Value*1000000
head(gasto_fun_paises)


```

* Graficamos la información:

```{r}
boxplot(gasto_fun_paises$Value~gasto_fun_paises$TIME,xlab="Años",
        ylab="Gasto", main='Gasto Sanitario',)
```

#### **2.INGRESOS EN EL SECTOR SANITARIO.**

* En primer lugar leemos el fichero:

```{r}
ingreso<-read.csv("C:/temp/IngresosSanitarios_Financiacion_clean.csv",sep= ",")
```

* Realicemos una breve inspección de los datos:

```{r}
str(ingreso)

```


```{r}
colnames(ingreso) #Nombre de las variables
nrow(ingreso) #Número de registros
ncol(ingreso) #Número de variables
```

* Transformamos el valor de la variable "Value" a unidades.

```{r}
#Ahora reescalamos un variable "Value" del Dataframe
ingreso$Value<-ingreso$Value*1000000
head(ingreso)

```

* Graficamos la información:

```{r}
boxplot(ingreso$Value~ingreso$TIME,xlab="Años", ylab="Ingresos", main='Ingresos Sanitarios',)
```


#### **3.ESTUDIO PARA ESPAÑA.**
##### **3.1 Creación de un DataFrame con la información para España.**

* Creamos un Dataframe con toda la información de España

* **Gasto Sanitario**

```{r}
spain_gasto_fun<-gasto_fun_paises[gasto_fun_paises$GEO=="Spain",]
gasto_fun_s<-spain_gasto_fun$Value
```

* **Ingresos Sanitarios**

```{r}
spain_ingreso<-ingreso[ingreso$GEO=="Spain",]
ingreso_s<-spain_ingreso$Value
```

* **Recursos: STAFF**

```{r}
#RECURSOS
#STAFF
medicos_e<-read.csv("C:/temp/Medicos_x_especialidad_clean.csv",sep= ",")
enfermeria<-read.csv("C:/temp/Personal_Enfermeria_Cuidados_clean.csv",sep= ",")


medicos_e<-medicos_e[(medicos_e$MED_SPEC=="Generalist medical practitioners"),]
medicos_e_s<-medicos_e[medicos_e$GEO=="Spain",]
medicos_sp<-medicos_e_s$Value


enfermeria<-enfermeria[(enfermeria$UNIT=="Number")&
  +(enfermeria$WSTATUS=="Professionally active")&
  +(enfermeria$ISCO08=="Nurses, midewives, health care assistants and home-based personal care workers"),]
enfermeria_s<-enfermeria[enfermeria$GEO =="Spain",]

enfermeria_sp<-enfermeria_s$Value
```

* **Prevención**

```{r}

cancer<-read.csv("C:/temp/Deteccion_Cancer_Mama_Cervix_clean.csv",sep= ",")
cancer_e<-cancer[cancer$SOURCE=="Survey data",]
cancer_e<-cancer_e[cancer_e$GEO=="Spain",]
cancer_e<-cancer_e[cancer_e$ICD10 == "Malignant neoplasm of breast",]
cancer_ep<-cancer_e$Value
cancer_ep
```

* **Causas de Muerte**

```{r}
#CAUSAS DE MUERTE
mortalidad<-read.csv("C:/temp/Mortalidad_Tratable_Prevenible_clean.csv",sep= ",")
mortalidad_e<-mortalidad[mortalidad$MORTALIT=="Total",]
mortalidad_e<-mortalidad_e[mortalidad_e$SEX=="Total",]
mortalidad_e<-mortalidad_e[mortalidad_e$UNIT=="Number",]
mortalidad_e<-mortalidad_e[mortalidad_e$GEO=="Spain",]
mortalidad_ep<-mortalidad_e$Value
mortalidad_ep<-c(mortalidad_ep,NA,NA,NA)
mortalidad_ep
```

* Creamos un DataFrame con la información para España.

```{r}
#Creamos el dataframe para España
year<-enfermeria_s$TIME
spain<-data.frame("year"=year,"gastos"=gasto_fun_s,
                  "ingresos"=ingreso_s,"medicos"=medicos_sp,
                  "enfermeros"=enfermeria_sp,
                  "diagnostico_cancer_mama"=cancer_ep,
                  "mortalidad"=mortalidad_ep)
spain
```

* Imputamos los valores de la variable **mortalidad** para los años 2017-2019

```{r}
#Imputamos valores de la variable mortalidad en los años 2017-2019
idx<-which(is.na(spain$mortalidad))
length(idx)
library(VIM)
output<-kNN(spain, variable=c("mortalidad"),k=3) 
spain<-output
```


* Normalizamos los valores del dataframe creado.

```{r}
spain_norm<-abs(scale(spain[,2:7]))
spain_norm
spain_norm<-cbind(spain_norm, year=c(year))
spain_norm<-data.frame(spain_norm)
```

##### **3.2 Aplicación de un modelo lineal que explique la variable mortalidad en función de gasto y número de staff en hospital.**

```{r}
modelo<-lm(mortalidad~medicos, data=spain) #modelo que explica la variable mortalidad 
                                         #en función del número de médicos disponibles.
summary(modelo)
modelo2<-lm(mortalidad~gastos, data=spain) #modelo que explica la variable mortalidad 
                                       #en función del gasto aplicado al sector sanitario.
summary(modelo2)
modelo3<-lm(mortalidad~enfermeros, data= spain)#modelo que explica la mortalidad 
                                       #en función del número de enfermeros disponibles.
summary(modelo3)
```

* A continuación realizamos predicciones de los modelos sobre nuevos datos, es decir, que mortalidad cabria esperar si se disminuye el gasto y el staff hospitalario?

```{r}
new_data=data.frame(gastos=973, medicos=50, enfermeros=23)
predict(modelo,new_data)
predict(modelo2,new_data)
predict(modelo3,new_data)
```

##### **3.3 Modelización del Gasto Sanitario por Paises.**

Buscamos agrupar los paises por similitud en el Gasto aplicado al sector sanitario.

```{r}
#Modelización Gasto por paises. Agrupamos los paises.
kmeans_res<-kmeans(gasto_fun_paises$Value, centers = 3)
kmeans_res
#Representamos los grupos
plot(gasto_fun_paises$Value, col=kmeans_res$cluster)
```

